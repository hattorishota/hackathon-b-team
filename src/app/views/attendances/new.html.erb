<div class="container">
  <h1>出社状況を登録</h1>

  <%= form_with model: @attendance, local: true do |f| %>
    <% if @attendance.errors.any? %>
      <div class="error-messages">
        <h3><%= pluralize(@attendance.errors.count, "error") %> prohibited this attendance from being saved:</h3>
        <ul>
          <% @attendance.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :name, '名前' %>
      <%= f.text_field :name, class: 'form-control', placeholder: '例: 山田太郎', id: 'name-input' %>
    </div>

    <div class="form-group">
      <%= f.label :location, '位置' %>
      <%= f.text_field :location, class: 'form-control', placeholder: '例: W1', id: 'location-input' %>
      <p class="map-hint">下のマップをクリックすると位置が自動入力されます</p>
      <div class="area-map">
        <%= image_tag 'area_map.png', alt: 'エリアマップ', class: 'map-image', id: 'clickable-map' %>
        <div id="seat-tooltip" class="seat-tooltip"></div>
      </div>
    </div>

    <div class="form-actions">
      <%= f.submit '登録する', class: 'button' %>
      <%= link_to '戻る', root_path, class: 'button button-secondary' %>
    </div>
  <% end %>
</div>

<style>
  .container {
    width: 100%;
    padding: 20px;
  }

  h1 {
    color: #333;
    margin-bottom: 30px;
  }

  .error-messages {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
  }

  .error-messages h3 {
    margin-top: 0;
    font-size: 16px;
  }

  .error-messages ul {
    margin-bottom: 0;
    padding-left: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #495057;
  }

  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 16px;
    box-sizing: border-box;
  }

  .form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
  }

  .form-actions {
    margin-top: 30px;
  }

  .button {
    display: inline-block;
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    text-decoration: none;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-right: 10px;
  }

  .button:hover {
    background-color: #0056b3;
  }

  .button-secondary {
    background-color: #6c757d;
  }

  .button-secondary:hover {
    background-color: #545b62;
  }

  body {
    background-color: #f5f5f5;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .area-map {
    margin-top: 15px;
    padding: 15px;
    background-color: #ffffff;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    position: relative;
  }

  .map-image {
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
    border-radius: 4px;
    cursor: pointer;
  }

  .map-image:hover {
    opacity: 0.9;
  }

  .map-hint {
    font-size: 14px;
    color: #6c757d;
    margin: 8px 0 0;
  }

  .seat-tooltip {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 14px;
    pointer-events: none;
    z-index: 1000;
    display: none;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .seat-tooltip.show {
    display: block;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const map = document.getElementById('clickable-map');
  const locationInput = document.getElementById('location-input');
  const nameInput = document.getElementById('name-input');
  const form = document.querySelector('form');
  const tooltip = document.getElementById('seat-tooltip');

  // 既存の出社情報を取得
  const existingAttendances = <%= raw @all_attendances.map { |a| { location: a.location, name: a.name } }.to_json %>;

  // 保存された名前を復元
  if (nameInput) {
    const savedName = localStorage.getItem('attendance_name');
    if (savedName && !nameInput.value) {
      nameInput.value = savedName;
    }
  }

  // フォーム送信時に名前を保存
  if (form && nameInput) {
    form.addEventListener('submit', function() {
      if (nameInput.value) {
        localStorage.setItem('attendance_name', nameInput.value);
      }
    });
  }

  if (!map || !locationInput) return;

  // エリア定義（パーセンテージベース）
  const areas = [
    // 左側 W1〜W10
    { name: 'W1', x1: 0, y1: 0, x2: 10, y2: 15 },
    { name: 'W2', x1: 0, y1: 15, x2: 10, y2: 23 },
    { name: 'W3', x1: 0, y1: 23, x2: 10, y2: 31 },
    { name: 'W4', x1: 0, y1: 31, x2: 10, y2: 39 },
    { name: 'W5', x1: 0, y1: 39, x2: 10, y2: 47 },
    { name: 'W6', x1: 0, y1: 47, x2: 10, y2: 55 },
    { name: 'W7', x1: 0, y1: 55, x2: 10, y2: 63 },
    { name: 'W8', x1: 0, y1: 68, x2: 10, y2: 76 },
    { name: 'W9', x1: 0, y1: 76, x2: 10, y2: 84 },
    { name: 'W10', x1: 0, y1: 84, x2: 10, y2: 92 },
    // 右側 E1〜E10
    { name: 'E1', x1: 90, y1: 12, x2: 100, y2: 20 },
    { name: 'E2', x1: 90, y1: 20, x2: 100, y2: 28 },
    { name: 'E3', x1: 90, y1: 28, x2: 100, y2: 36 },
    { name: 'E4', x1: 90, y1: 36, x2: 100, y2: 44 },
    { name: 'E5', x1: 90, y1: 44, x2: 100, y2: 52 },
    { name: 'E6', x1: 90, y1: 57, x2: 100, y2: 65 },
    { name: 'E7', x1: 90, y1: 65, x2: 100, y2: 73 },
    { name: 'E8', x1: 90, y1: 73, x2: 100, y2: 81 },
    { name: 'E9', x1: 90, y1: 81, x2: 100, y2: 89 },
    { name: 'E10', x1: 90, y1: 89, x2: 100, y2: 97 },
    // 上部 FUJI
    { name: 'FUJI 08', x1: 10, y1: 0, x2: 18, y2: 10 },
    { name: 'FUJI 07', x1: 18, y1: 0, x2: 26, y2: 10 },
    { name: 'FUJI 06', x1: 26, y1: 0, x2: 34, y2: 10 },
    { name: 'FUJI 05', x1: 15, y1: 10, x2: 25, y2: 20 },
    { name: 'FUJI 04', x1: 12, y1: 27, x2: 22, y2: 37 },
    { name: 'FUJI 03', x1: 12, y1: 62, x2: 22, y2: 72 },
    { name: 'FUJI 02', x1: 20, y1: 68, x2: 30, y2: 78 },
    { name: 'FUJI 01', x1: 15, y1: 90, x2: 25, y2: 100 },
    // TOWER（右側上部）
    { name: 'TOWER 05', x1: 78, y1: 0, x2: 86, y2: 10 },
    { name: 'TOWER 06', x1: 86, y1: 0, x2: 92, y2: 10 },
    { name: 'TOWER 07', x1: 92, y1: 0, x2: 100, y2: 10 },
    { name: 'TOWER 04', x1: 78, y1: 45, x2: 88, y2: 55 },
    { name: 'TOWER 03', x1: 78, y1: 55, x2: 88, y2: 65 },
    { name: 'TOWER 02', x1: 78, y1: 65, x2: 88, y2: 75 },
    { name: 'TOWER 01', x1: 78, y1: 75, x2: 88, y2: 85 },
    // GROWTH（中央）
    { name: 'GROWTH 02', x1: 38, y1: 45, x2: 48, y2: 55 },
    { name: 'GROWTH 01', x1: 48, y1: 45, x2: 58, y2: 55 },
    { name: 'GROWTH 03', x1: 58, y1: 45, x2: 68, y2: 55 },
    { name: 'GROWTH 04', x1: 42, y1: 55, x2: 52, y2: 65 },
    // SMILE
    { name: 'SMILE', x1: 55, y1: 55, x2: 65, y2: 65 },
    // AGILE
    { name: 'AGILE', x1: 23, y1: 68, x2: 33, y2: 78 },
    // ONE
    { name: 'ONE', x1: 35, y1: 68, x2: 45, y2: 78 },
    // TOGETHER
    { name: 'TOGETHER 01', x1: 45, y1: 68, x2: 55, y2: 78 },
    { name: 'TOGETHER 02', x1: 55, y1: 68, x2: 65, y2: 78 },
    // OASIS（青いエリア）
    { name: 'OASIS', x1: 65, y1: 45, x2: 78, y2: 78 },
    // Cloud（下部緑）
    { name: 'Cloud', x1: 30, y1: 82, x2: 78, y2: 98 },
    // SEED
    { name: 'SEED 01', x1: 3, y1: 62, x2: 12, y2: 68 },
    { name: 'SEED 02', x1: 85, y1: 5, x2: 95, y2: 12 },
  ];

  // エリアの中心点を計算
  function getAreaCenter(area) {
    return {
      x: (area.x1 + area.x2) / 2,
      y: (area.y1 + area.y2) / 2
    };
  }

  // 2点間の距離を計算
  function getDistance(x1, y1, x2, y2) {
    return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
  }

  // 最も近いエリアを見つける
  function findNearestArea(x, y) {
    let nearest = null;
    let minDistance = Infinity;

    for (const area of areas) {
      const center = getAreaCenter(area);
      const distance = getDistance(x, y, center.x, center.y);
      if (distance < minDistance) {
        minDistance = distance;
        nearest = area;
      }
    }

    return nearest;
  }

  map.addEventListener('click', function(e) {
    const rect = map.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    // クリック位置に該当するエリアを探す
    for (const area of areas) {
      if (x >= area.x1 && x <= area.x2 && y >= area.y1 && y <= area.y2) {
        locationInput.value = area.name;
        locationInput.focus();
        return;
      }
    }

    // どのエリアにも該当しない場合は最も近いエリアを入力
    const nearest = findNearestArea(x, y);
    if (nearest) {
      locationInput.value = nearest.name;
      locationInput.focus();
    }
  });

  // ホバー時にツールチップを表示
  map.addEventListener('mousemove', function(e) {
    if (!tooltip) return;

    const rect = map.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    // マウス位置に該当するエリアを探す
    let hoveredArea = null;
    for (const area of areas) {
      if (x >= area.x1 && x <= area.x2 && y >= area.y1 && y <= area.y2) {
        hoveredArea = area;
        break;
      }
    }

    if (hoveredArea) {
      // そのエリアに座っている人を探す
      const occupant = existingAttendances.find(att => att.location === hoveredArea.name);

      if (occupant) {
        // ツールチップを表示
        tooltip.textContent = `${hoveredArea.name}: ${occupant.name}`;
        tooltip.classList.add('show');

        // ツールチップの位置を調整（マウスカーソルの少し右下に表示）
        const mapRect = map.getBoundingClientRect();
        const areaMapRect = map.parentElement.getBoundingClientRect();
        tooltip.style.left = (e.clientX - areaMapRect.left + 10) + 'px';
        tooltip.style.top = (e.clientY - areaMapRect.top + 10) + 'px';
      } else {
        tooltip.classList.remove('show');
      }
    } else {
      tooltip.classList.remove('show');
    }
  });

  // マウスがマップから離れたらツールチップを非表示
  map.addEventListener('mouseleave', function() {
    if (tooltip) {
      tooltip.classList.remove('show');
    }
  });
});
</script>
